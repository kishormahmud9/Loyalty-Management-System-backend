generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/**
 * =========================
 * ENUMS
 * =========================
 */

enum UserRole {
  SYSTEM_OWNER
  BUSINESS_OWNER
  STAFF
  CUSTOMER
}

enum UserStatus {
  ACTIVE
  SUSPENDED
  BLOCKED
}

enum StaffRole {
  MANAGER
  CASHIER
  STAFF
}

enum OAuthProvider {
  email
  google
  facebook
  apple
}

enum TicketPriority {
  HIGH
  MEDIUM
  LOW
}

enum TicketStatus {
  OPEN
  IN_PROGRESS
  RESOLVED
  CLOSED
}

enum TransactionType {
  EARN
  REDEEM
  ADJUST
}

enum BillingStatus {
  PAID
  PENDING
  FAILED
}

/**
 * =========================
 * USER
 * =========================
 */

model User {
  id           String  @id @default(uuid())
  name         String
  email        String  @unique
  passwordHash String?
  avatarUrl    String?

  role   UserRole   @default(CUSTOMER)
  status UserStatus @default(ACTIVE)

  isVerified Boolean @default(false)

  oauthProvider   OAuthProvider @default(email)
  oauthProviderId String?

  forgotPasswordStatus Boolean @default(false)

  phone   String?
  address String?

  // Relations
  businessesOwned Business[]      @relation("BusinessOwner")
  staffProfile    Staff?
  ticketsCreated  SupportTicket[] @relation("TicketCreator")
  activityLogs    ActivityLog[]
  support         Support[]
    rewards   Reward[]
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  @@index([role])
}

// Business Owner Starts 

enum Priority {
  LOW
  MEDIUM
  HIGH
}

model Support {
  id       Int    @id @default(autoincrement())
  ticketId String @unique

  userId     String
  businessId String
  branchId   String

  date     DateTime
  issue    String
  priority Priority

  user     User     @relation(fields: [userId], references: [id])
  business Business @relation(fields: [businessId], references: [id])
  branch   Branch   @relation(fields: [branchId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Reward {
  id           String   @id @default(uuid())

  rewardName   String
  rewardPoints Int
  rewardType   String
  expiryDays   Int
  earningRule  String
  reward       String

  userId       String
  businessId   String
  branchId     String

  user     User     @relation(fields: [userId], references: [id])
  business Business @relation(fields: [businessId], references: [id])
  branch   Branch   @relation(fields: [branchId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([businessId])
  @@index([branchId])
}

// Business Owner ends 

/**
 * =========================
 * BUSINESS (TENANT)
 * =========================
 */

model Business {
  id       String  @id @default(uuid())
  ownerId  String
  name     String
  industry String?
  phone    String?
  address  String?
  city     String?
  country  String?

  qrCode      String    @unique
  isActive    Boolean   @default(true)
  trialEndsAt DateTime? // âœ… ADD THIS

  // Relations
  owner          User               @relation("BusinessOwner", fields: [ownerId], references: [id])
  branches       Branch[]
  staff          Staff[]
  loyaltyRule    LoyaltyRule?
  rewards        Reward[]
  transactions   PointTransaction[]
  supportTickets SupportTicket[]
  billings       Billing[]
  supports       Support[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

/**
 * =========================
 * BRANCH
 * =========================
 */

model Branch {
  id         String  @id @default(uuid())
  businessId String
  name       String?
  address    String
  city       String?
  country    String?
  isActive   Boolean @default(true)

  business Business @relation(fields: [businessId], references: [id], onDelete: Cascade)

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  supports  Support[]
    rewards Reward[]
}

/**
 * =========================
 * STAFF
 * =========================
 */

model Staff {
  id         String    @id @default(uuid())
  userId     String    @unique
  businessId String
  role       StaffRole
  isActive   Boolean   @default(true)

  user     User     @relation(fields: [userId], references: [id])
  business Business @relation(fields: [businessId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

/**
 * =========================
 * LOYALTY RULE
 * =========================
 */

model LoyaltyRule {
  id         String  @id @default(uuid())
  businessId String  @unique
  pointsRate Int
  minSpend   Float?
  isActive   Boolean @default(true)

  business Business @relation(fields: [businessId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}




/**
 * =========================
 * POINT TRANSACTION
 * =========================
 */

model PointTransaction {
  id          String          @id @default(uuid())
  businessId  String
  staffId     String?
  customerRef String
  points      Int
  type        TransactionType

  business Business @relation(fields: [businessId], references: [id])

  createdAt DateTime @default(now())
}

/**
 * =========================
 * SUPPORT TICKET
 * =========================
 */

model SupportTicket {
  id          String         @id @default(uuid())
  businessId  String?
  createdBy   String
  subject     String
  description String
  priority    TicketPriority
  status      TicketStatus   @default(OPEN)

  business Business? @relation(fields: [businessId], references: [id])
  creator  User      @relation("TicketCreator", fields: [createdBy], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([priority])
}

/**
 * =========================
 * BILLING
 * =========================
 */

model Billing {
  id         String        @id @default(uuid())
  businessId String
  status     BillingStatus @default(PENDING)
  issue      Boolean       @default(false)

  business Business @relation(fields: [businessId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([businessId])
  @@index([issue])
}

/**
 * =========================
 * ACTIVITY LOG
 * =========================
 */

model ActivityLog {
  id       String @id @default(uuid())
  userId   String
  action   String
  metadata Json?

  user User @relation(fields: [userId], references: [id])

  createdAt DateTime @default(now())
}
