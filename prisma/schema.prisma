generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/**
 * =========================
 * ENUMS
 * =========================
 */

enum UserRole {
  SYSTEM_OWNER
  BUSINESS_OWNER
  STAFF
  CUSTOMER
}

enum UserStatus {
  ACTIVE
  SUSPENDED
  BLOCKED
}

enum StaffRole {
  MANAGER
  CASHIER
  STAFF
}

enum OAuthProvider {
  email
  google
  facebook
  apple
}

enum TicketPriority {
  HIGH
  MEDIUM
  LOW
}

enum TicketStatus {
  OPEN
  IN_PROGRESS
  RESOLVED
  CLOSED
}

enum TransactionType {
  EARN
  REDEEM
  ADJUST
}

enum BillingStatus {
  PAID
  PENDING
  FAILED
}

/**
 * =========================
 * USER
 * =========================
 */

model User {
  id           String  @id @default(uuid())
  name         String
  email        String  @unique
  passwordHash String?
  avatarUrl    String?

  role   UserRole   @default(CUSTOMER)
  status UserStatus @default(ACTIVE)

  isVerified Boolean @default(false)

  oauthProvider   OAuthProvider @default(email)
  oauthProviderId String?

  forgotPasswordStatus Boolean @default(false)

  phone   String?
  address String?

  // Relations
  businessesOwned Business[]      @relation("BusinessOwner")
  staffProfile    Staff?
  ticketsCreated  SupportTicket[] @relation("TicketCreator")
  activityLogs    ActivityLog[]
  support         Support[]
  redeemRewards   RedeemReward[]
  earnRewards     EarnReward[]
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  @@index([role])
}

/**
 * =========================
 * CUSTOMER
 * =========================
 */

model Customer {
  id                   String   @id @default(uuid())
  name                 String
  email                String   @unique
  passwordHash         String?
  avatarUrl            String?
  isVerified           Boolean  @default(false)
  role                 UserRole @default(CUSTOMER)
  forgotPasswordStatus Boolean  @default(false)

  qrCode    String  @unique // The 6 digit code
  qrScanner String? // Additional field requested

  // Relations
  branchData    CustomerBranchData[]
  rewardHistory RewardHistory[]
  sessions      CustomerSession[]
  reviews       Review[]
  undoRequests      TransactionUndoRequest[]
  adjustmentRequests PointAdjustmentRequest[]


  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model CustomerBranchData {
  id         String @id @default(uuid())
  customerId String
  businessId String
  branchId   String

  customer Customer @relation(fields: [customerId], references: [id])
  business Business @relation(fields: [businessId], references: [id])
  branch   Branch   @relation(fields: [branchId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([customerId, branchId])
}

model CustomerSession {
  id          String   @id @default(uuid())
  customerId  String
  refreshHash String
  userAgent   String?
  ipAddress   String?
  expiresAt   DateTime
  createdAt   DateTime @default(now())

  customer Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@index([customerId])
}

// Business Owner Starts 

enum Priority {
  LOW
  MEDIUM
  HIGH
}

model Support {
  id       String @id @default(uuid())
  ticketId String @unique

  userId     String
  businessId String
  branchId   String

  date     DateTime
  issue    String
  priority Priority

  user     User     @relation(fields: [userId], references: [id])
  business Business @relation(fields: [businessId], references: [id])
  branch   Branch   @relation(fields: [branchId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum RewardStatus {
  ACTIVE
  INACTIVE
}

enum RewardType {
  FREE_ITEM
  EARN
  REDEEM
}

model RedeemReward {
  id String @id @default(uuid())

  rewardName          String
  rewardPoints        Int
  rewardType          RewardType
  rewardImageFilePath String? // üîê internal use
  rewardImage         String? // üåç frontend use
  expiryDays          Int
  earningRule         String
  reward              String
  rewardStatus        RewardStatus @default(ACTIVE)

  userId     String
  businessId String
  branchId   String

  user     User     @relation(fields: [userId], references: [id])
  business Business @relation(fields: [businessId], references: [id])
  branch   Branch   @relation(fields: [branchId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([businessId])
  @@index([branchId])
}

model EarnReward {
  id String @id @default(uuid())

  rewardName          String
  earnPoint           Int
  rewardType          RewardType
  rewardImageFilePath String? // üîê internal use
  rewardImage         String? // üåç frontend use
  expiryDays          Int
  earningRule         String
  reward              String
  rewardStatus        RewardStatus @default(ACTIVE)

  userId     String
  businessId String
  branchId   String

  user     User     @relation(fields: [userId], references: [id])
  business Business @relation(fields: [businessId], references: [id])
  branch   Branch   @relation(fields: [branchId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([businessId])
  @@index([branchId])
}

// Business Owner ends 

/**
 * =========================
 * BUSINESS (TENANT)
 * =========================
 */

model Business {
  id       String  @id @default(uuid())
  ownerId  String
  name     String
  industry String?
  phone    String?
  address  String?
  city     String?
  country  String?

  qrCode      String    @unique
  isActive    Boolean   @default(true)
  trialEndsAt DateTime?

  // Relations
  owner              User                 @relation("BusinessOwner", fields: [ownerId], references: [id])
  branche            Branch[]
  staff              Staff[]
  loyaltyRule        LoyaltyRule?
  redeemRewards      RedeemReward[]
  earnRewards        EarnReward[]
  transactions       PointTransaction[]
  supportTickets     SupportTicket[]
  supports           Support[]
  billings           Billing[]
  customerBranchData CustomerBranchData[]
  rewardHistory      RewardHistory[]
  undoRequests TransactionUndoRequest[]
  adjustmentRequests PointAdjustmentRequest[]


  createdAt            DateTime              @default(now())
  updatedAt            DateTime              @updatedAt
  activityLogs         ActivityLog[]
  businessSubscription BusinessSubscription?
  reviews              Review[]
  staffPermission      StaffPermission?
}

/**
 * =========================
 * BRANCH
 * =========================
 */

model Branch {
  id         String  @id @default(uuid())
  businessId String
  name       String?
  address    String
  city       String?
  country    String?
  isActive   Boolean @default(true)

  business Business @relation(fields: [businessId], references: [id], onDelete: Cascade)

  supports           Support[]
  redeemRewards      RedeemReward[]
  earnRewards        EarnReward[]
  staff              Staff[]
  customerBranchData CustomerBranchData[]
  rewardHistory      RewardHistory[]

  
  pointTransactions  PointTransaction[]
  undoRequests      TransactionUndoRequest[]
  adjustmentRequests PointAdjustmentRequest[]

  reviews           Review[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model RewardHistory {
  id String @id @default(uuid())

  rewardPoints       Int       @default(0)
  activeRewards     Int       @default(0)
  availableRewards  Int       @default(0)
  lastRewardReceived DateTime?
  cardExpireDate    DateTime?
  earningRule       String?
  walletApp         String? // Google Wallet or Apple Wallet

  customerId String
  businessId String
  branchId   String

  customer Customer @relation(fields: [customerId], references: [id])
  business Business @relation(fields: [businessId], references: [id])
  branch   Branch   @relation(fields: [branchId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([customerId, branchId])
  @@index([businessId])
  @@index([branchId])
}

/**
 * =========================
 * STAFF
 * =========================
 */

model Staff {
  id         String    @id @default(uuid())
  userId     String    @unique
  businessId String
  branchId   String
  role       StaffRole
  isActive   Boolean   @default(true)

  user      User     @relation(fields: [userId], references: [id])
  business  Business @relation(fields: [businessId], references: [id])
  branch    Branch   @relation(fields: [branchId], references: [id])
  
  undoRequests TransactionUndoRequest[]
  adjustmentRequests PointAdjustmentRequest[]


  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  

}

/**
 * =========================
 * LOYALTY RULE
 * =========================
 */

model LoyaltyRule {
  id         String  @id @default(uuid())
  businessId String  @unique
  pointsRate Int
  minSpend   Float?
  isActive   Boolean @default(true)

  business Business @relation(fields: [businessId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

/**
 * =========================
 * POINT TRANSACTION
 * =========================
 */

model PointTransaction {
  id                  String @id @default(uuid())

  businessId           String
  branchId             String?
  staffId              String?
  customerId           String?

  points               Int
  type                 TransactionType

  // link to adjustment request (APPROVED only)
  adjustmentRequestId  String? @unique
  adjustmentRequest    PointAdjustmentRequest? @relation(fields: [adjustmentRequestId], references: [id])

  // REQUIRED opposite relations
  business Business @relation(fields: [businessId], references: [id])
  branch   Branch?  @relation(fields: [branchId], references: [id])

  createdAt DateTime @default(now())

  @@index([businessId])
  @@index([branchId])
}
/**
 * =========================
 * SUPPORT TICKET
 * =========================
 */

model SupportTicket {
  id       String @id @default(uuid())
  ticketNo String @unique

  businessId String?
  createdBy  String

  subject     String
  description String
  priority    TicketPriority
  status      TicketStatus   @default(OPEN)

  resolvedAt DateTime?
  closedAt   DateTime?

  business Business? @relation(fields: [businessId], references: [id])
  creator  User      @relation("TicketCreator", fields: [createdBy], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([priority])
  @@index([status])
}

/**
 * =========================
 * BILLING
 * =========================
 */

model Billing {
  id         String        @id @default(uuid())
  businessId String
  status     BillingStatus @default(PENDING)
  issue      Boolean       @default(false)

  business Business @relation(fields: [businessId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([businessId])
  @@index([issue])
}

// ACTIVITY LOG

enum ActivityActionType {
  CREATE
  UPDATE
  DELETE
  LOGIN
  LOGOUT
  OTHER
}

model ActivityLog {
  id String @id @default(uuid())

  userId     String
  businessId String?

  action     String
  actionType ActivityActionType @default(OTHER)

  metadata Json?

  user     User      @relation(fields: [userId], references: [id])
  business Business? @relation(fields: [businessId], references: [id])

  createdAt DateTime @default(now())

  @@index([businessId])
  @@index([actionType])
  @@index([createdAt])
}

/**
 * =========================
 * PLAN (SYSTEM OWNER)
 * =========================
 */

model Plan {
  id    String @id @default(uuid())
  name  String @unique // Starter, Grow, Business
  price Int // 25, 45, 60

  maxBranches Int
  maxStaff    Int
  maxCards    Int

  isActive Boolean @default(true)

  createdAt             DateTime               @default(now())
  updatedAt             DateTime               @updatedAt
  businessSubscriptions BusinessSubscription[]
}

/**
 * =========================
 * BUSINESS SUBSCRIPTION
 * =========================
 */

enum SubscriptionStatus {
  ACTIVE
  EXPIRED
  CANCELLED
}

model BusinessSubscription {
  id         String @id @default(uuid())
  businessId String @unique
  planId     String

  // snapshot fields (TEMPORARILY OPTIONAL)
  planName    String?
  price       Float?
  maxBranches Int?
  maxStaff    Int?
  maxCards    Int?

  status    SubscriptionStatus @default(ACTIVE)
  startDate DateTime           @default(now())
  endDate   DateTime?

  business Business @relation(fields: [businessId], references: [id])
  plan     Plan     @relation(fields: [planId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum UndoRequestStatus {
  PENDING
  APPROVED
  REJECTED
}

model TransactionUndoRequest {
  id String @id @default(uuid())

  adjustmentRequestId String   
  customerId          String
  businessId          String
  branchId            String?
  staffId             String?
  reason              String

  status UndoRequestStatus @default(PENDING)

  reviewedBy String?
  reviewedAt DateTime?

  // NO Prisma relation to PointAdjustmentRequest
  customer Customer @relation(fields: [customerId], references: [id])
  business Business @relation(fields: [businessId], references: [id])
  branch   Branch?  @relation(fields: [branchId], references: [id])
  staff    Staff?   @relation(fields: [staffId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([staffId, customerId])
  @@index([adjustmentRequestId])
}

model Review {
  id         String   @id @default(uuid())
  customerId String
  businessId String
  branchId   String
  reviewText String
  branchName String
  star       Int
  hideStatus Boolean  @default(false)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  customer Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)
  business Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  branch   Branch   @relation(fields: [branchId], references: [id], onDelete: Cascade)

  @@index([businessId])
  @@index([branchId])
}

model StaffPermission {
  id                       String   @id @default(uuid())
  businessId               String   @unique
  allowAddingPoints        Boolean  @default(false)
  allowRedeeming           Boolean  @default(false)
  allowVoids               Boolean  @default(false)
  viewCustomerList         Boolean  @default(false)
  allowViewingActiveOffers Boolean  @default(false)
  editLoyaltyRulesOrOffers Boolean  @default(false)
  addRemoveOtherStaff      Boolean  @default(false)
  createdAt                DateTime @default(now())
  updatedAt                DateTime @updatedAt

  business Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
}

enum AdjustmentType {
  ADD
  REDEEM
  UNDO
}

model PointAdjustmentRequest {
  id           String @id @default(uuid())

  type         AdjustmentType
  points       Int

  customerId   String
  staffId      String?
  businessId   String
  branchId     String?

  reason       String?
  status       UndoRequestStatus @default(PENDING)

  reviewedBy   String?
  reviewedAt   DateTime?

  // reverse relation (THIS FIXES THE ERROR)
  transaction  PointTransaction?

  customer Customer @relation(fields: [customerId], references: [id])
  staff    Staff?   @relation(fields: [staffId], references: [id])
  business Business @relation(fields: [businessId], references: [id])
  branch   Branch?  @relation(fields: [branchId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([staffId, customerId])
  @@index([branchId])
  @@index([status])
}
