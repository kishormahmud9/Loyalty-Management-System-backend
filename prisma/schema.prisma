generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  SYSTEM_OWNER
  BUSINESS_OWNER
  STAFF
  CUSTOMER
}

enum UserStatus {
  ACTIVE
  SUSPENDED
  BLOCKED
}

enum StaffRole {
  MANAGER
  CASHIER
  STAFF
}

enum OAuthProvider {
  email
  google
  facebook
  apple
}

enum TicketPriority {
  HIGH
  MEDIUM
  LOW
}

enum TicketStatus {
  OPEN
  IN_PROGRESS
  RESOLVED
  CLOSED
}

enum TransactionType {
  EARN
  REDEEM
  ADJUST
}

enum BillingStatus {
  PAID
  PENDING
  FAILED
}

enum ClaimStatus {
  CLAIM
  CLAIMED
}

enum Priority {
  LOW
  MEDIUM
  HIGH
}

enum RewardStatus {
  ACTIVE
  INACTIVE
}

enum RewardType {
  FREE_ITEM
  EARN
  REDEEM
}

enum CardType {
  stamp_card
  reward_card
}

enum BarcodeType {
  bar_code
  qr_code
}

enum RewardProgram {
  spend
  visit
}

enum ActivityActionType {
  CREATE
  UPDATE
  DELETE
  LOGIN
  LOGOUT
  OTHER
}

enum SubscriptionStatus {
  ACTIVE
  INACTIVE
  EXPIRED
  CANCELLED
}

enum UndoRequestStatus {
  PENDING
  APPROVED
  REJECTED
}

enum AdjustmentType {
  ADD
  REDEEM
  UNDO
}

model User {
  id                   String          @id @default(uuid())
  name                 String
  email                String          @unique
  passwordHash         String?
  avatarUrl            String?
  role                 UserRole        @default(BUSINESS_OWNER)
  isVerified           Boolean         @default(false)
  oauthProvider        OAuthProvider   @default(email)
  oauthProviderId      String?
  createdAt            DateTime        @default(now())
  updatedAt            DateTime        @updatedAt
  forgotPasswordStatus Boolean         @default(false)
  address              String?
  phone                String?
  status               UserStatus      @default(ACTIVE)
  isPinSet             Boolean         @default(false)
  pinHash              String?
  activityLogs         ActivityLog[]
  businessesOwned      Business[]      @relation("BusinessOwner")
  earnRewards          EarnReward[]
  redeemRewards        RedeemReward[]
  staffProfile         Staff?
  support              Support[]
  ticketsCreated       SupportTicket[] @relation("TicketCreator")

  @@index([role])
}

model Customer {
  id                         String                      @id @default(uuid())
  name                       String
  email                      String                      @unique
  passwordHash               String?
  avatarUrl                  String?
  isVerified                 Boolean                     @default(false)
  forgotPasswordStatus       Boolean                     @default(false)
  qrCode                     String                      @unique
  qrScanner                  String?
  createdAt                  DateTime                    @default(now())
  updatedAt                  DateTime                    @updatedAt
  role                       UserRole                    @default(CUSTOMER)
  qrCodePath                 String?
  qrCodeUrl                  String?
  address                    String?
  phone                      String?
  fcmToken                   String?
  avatarFilePath             String?
  activeBranchId             String?
  claims                     ClaimReward[]
  branchData                 CustomerBranchData[]
  cardWallets                CustomerCardWallet[]
  notifications              CustomerNotification?
  sessions                   CustomerSession[]
  notificationCustomerStates NotificationCustomerState[]
  adjustmentRequests         PointAdjustmentRequest[]
  reviews                    Review[]
  rewardHistory              RewardHistory[]
  undoRequests               TransactionUndoRequest[]
  geoNotificationStates      GeoNotificationState[]
}

model CustomerNotification {
  id               String   @id @default(uuid())
  customerId       String   @unique
  smsUpdates       Boolean  @default(false)
  allowLocation    Boolean  @default(false)
  pushNotification Boolean  @default(false)
  birthdayRewards  Boolean  @default(false)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  customer         Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)
}

model CustomerBranchData {
  id         String   @id @default(uuid())
  customerId String
  businessId String
  branchId   String
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  branch     Branch   @relation(fields: [branchId], references: [id])
  business   Business @relation(fields: [businessId], references: [id])
  customer   Customer @relation(fields: [customerId], references: [id])

  @@unique([customerId, branchId])
}

model CustomerSession {
  id          String   @id @default(uuid())
  customerId  String
  refreshHash String
  userAgent   String?
  ipAddress   String?
  expiresAt   DateTime
  createdAt   DateTime @default(now())
  customer    Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@index([customerId])
}

model Support {
  id         String   @id @default(uuid())
  businessId String
  branchId   String?
  issue      String
  priority   Priority
  date       DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  userId     String
  ticketId   String   @unique
  branchName String?
  status     String?  @default("pending")
  branch     Branch?  @relation(fields: [branchId], references: [id])
  business   Business @relation(fields: [businessId], references: [id])
  user       User     @relation(fields: [userId], references: [id])
}

model RedeemReward {
  id                  String        @id @default(uuid())
  rewardName          String
  rewardPoints        Int
  rewardType          RewardType
  rewardImageFilePath String?
  rewardImage         String?
  expiryDays          Int
  earningRule         String
  reward              String
  rewardStatus        RewardStatus  @default(ACTIVE)
  userId              String
  businessId          String
  branchId            String
  createdAt           DateTime      @default(now())
  updatedAt           DateTime      @updatedAt
  claims              ClaimReward[]
  branch              Branch        @relation(fields: [branchId], references: [id])
  business            Business      @relation(fields: [businessId], references: [id])
  user                User          @relation(fields: [userId], references: [id])

  @@index([businessId])
  @@index([branchId])
}

model ClaimReward {
  id             String       @id @default(uuid())
  redeemRewardId String
  branchId       String
  customerId     String
  claimStatus    ClaimStatus  @default(CLAIM)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  branch         Branch       @relation(fields: [branchId], references: [id])
  customer       Customer     @relation(fields: [customerId], references: [id])
  redeemReward   RedeemReward @relation(fields: [redeemRewardId], references: [id])

  @@index([customerId])
  @@index([branchId])
}

model EarnReward {
  id                  String       @id @default(uuid())
  rewardName          String
  earnPoint           Int
  rewardType          RewardType
  rewardImageFilePath String?
  rewardImage         String?
  expiryDays          Int
  earningRule         String
  reward              String
  rewardStatus        RewardStatus @default(ACTIVE)
  userId              String
  businessId          String
  branchId            String
  createdAt           DateTime     @default(now())
  updatedAt           DateTime     @updatedAt
  branch              Branch       @relation(fields: [branchId], references: [id])
  business            Business     @relation(fields: [businessId], references: [id])
  user                User         @relation(fields: [userId], references: [id])

  @@index([businessId])
  @@index([branchId])
}

model Card {
  id                  String               @id @default(uuid())
  businessId          String
  cardType            CardType             @default(stamp_card)
  cardDesc            String
  companyName         String
  rewardProgram       RewardProgram        @default(spend)
  stampsCount         Int                  @default(0)
  earnRuleType        String?
  earnValue           Int?
  earnUnit            Int?
  barcodeType         BarcodeType          @default(qr_code)
  logo                String?
  cardBackground      String?
  stampBackground     String?
  activeStamp         String?
  inactiveStamp       String?
  textColor           String?
  earnedRewardMessage String?
  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @updatedAt
  isActive            Boolean              @default(true)
  expiryDate          DateTime?
  logoFilePath        String?
  stampBackgroundPath String?
  business            Business             @relation(fields: [businessId], references: [id], onDelete: Cascade)
  cardWallets         CustomerCardWallet[]

  @@index([businessId])
}

model Business {
  id                    String                     @id @default(uuid())
  name                  String
  isActive              Boolean                    @default(true)
  createdAt             DateTime                   @default(now())
  updatedAt             DateTime                   @updatedAt
  address               String?
  city                  String?
  country               String?
  industry              String?
  ownerId               String
  phone                 String?
  qrCode                String                     @unique
  trialEndsAt           DateTime?
  stripeCustomerId      String?                    @unique
  businessLogo          String?
  businessLogoFilePath  String?
  businessLogoUrl       String?
  activityLogs          ActivityLog[]
  billings              Billing[]
  branches              Branch[]
  owner                 User                       @relation("BusinessOwner", fields: [ownerId], references: [id])
  businessSubscriptions BusinessSubscription[]
  cards                 Card[]
  customerBranchData    CustomerBranchData[]
  earnRewards           EarnReward[]
  loyaltyRule           LoyaltyRule?
  adjustmentRequests    PointAdjustmentRequest[]
  transactions          PointTransaction[]
  redeemRewards         RedeemReward[]
  reviews               Review[]
  rewardHistory         RewardHistory[]
  staff                 Staff[]
  staffPermission       StaffPermission?
  supports              Support[]
  supportTickets        SupportTicket[]
  undoRequests          TransactionUndoRequest[]
  notificationSettings  businessOwnerNotification?
}

model Branch {
  id         String   @id @default(uuid())
  businessId String
  name       String?
  address    String
  city       String?
  isActive   Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  country    String?

  latitude  Float?
  longitude Float?

  businessName         String?
  managerName          String?
  staffCount           Int     @default(0)
  branchQrCode         String?
  branchQrCodeFilePath String?
  branchQrCodeUrl      String?
  branchImageFilePath  String?
  branchImageUrl       String?

  business              Business                   @relation(fields: [businessId], references: [id], onDelete: Cascade)
  claims                ClaimReward[]
  customerBranchData    CustomerBranchData[]
  earnRewards           EarnReward[]
  adjustmentRequests    PointAdjustmentRequest[]
  pointTransactions     PointTransaction[]
  redeemRewards         RedeemReward[]
  reviews               Review[]
  rewardHistory         RewardHistory[]
  staff                 Staff[]
  supports              Support[]
  undoRequests          TransactionUndoRequest[]
  notificationSetting   BranchNotificationSetting?
  geoNotificationStates GeoNotificationState[]
}

model RewardHistory {
  id                 String    @id @default(uuid())
  rewardPoints       Int       @default(0)
  activeRewards      Int       @default(0)
  availableRewards   Int       @default(0)
  lastRewardReceived DateTime?
  cardExpireDate     DateTime?
  earningRule        String?
  walletApp          String?
  customerId         String
  businessId         String
  branchId           String
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt
  branch             Branch    @relation(fields: [branchId], references: [id])
  business           Business  @relation(fields: [businessId], references: [id])
  customer           Customer  @relation(fields: [customerId], references: [id])

  @@unique([customerId, branchId])
  @@index([businessId])
  @@index([branchId])
}

model Staff {
  id                 String                   @id @default(uuid())
  userId             String                   @unique
  businessId         String
  role               StaffRole
  isActive           Boolean                  @default(true)
  createdAt          DateTime                 @default(now())
  updatedAt          DateTime                 @updatedAt
  branchId           String
  adjustmentRequests PointAdjustmentRequest[]
  branch             Branch                   @relation(fields: [branchId], references: [id])
  business           Business                 @relation(fields: [businessId], references: [id])
  user               User                     @relation(fields: [userId], references: [id])
  undoRequests       TransactionUndoRequest[]
}

model LoyaltyRule {
  id         String   @id @default(uuid())
  businessId String   @unique
  pointsRate Int
  minSpend   Float?
  isActive   Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  business   Business @relation(fields: [businessId], references: [id])
}

model PointTransaction {
  id                  String                  @id @default(uuid())
  businessId          String
  staffId             String?
  points              Int
  type                TransactionType
  createdAt           DateTime                @default(now())
  branchId            String?
  customerId          String?
  adjustmentRequestId String?                 @unique
  adjustmentRequest   PointAdjustmentRequest? @relation(fields: [adjustmentRequestId], references: [id])
  branch              Branch?                 @relation(fields: [branchId], references: [id])
  business            Business                @relation(fields: [businessId], references: [id])

  @@index([businessId])
  @@index([branchId])
}

model SupportTicket {
  id          String         @id @default(uuid())
  priority    TicketPriority
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  businessId  String?
  createdBy   String
  description String
  status      TicketStatus   @default(OPEN)
  subject     String
  closedAt    DateTime?
  resolvedAt  DateTime?
  ticketNo    String         @unique
  business    Business?      @relation(fields: [businessId], references: [id])
  creator     User           @relation("TicketCreator", fields: [createdBy], references: [id])

  @@index([priority])
  @@index([status])
}

model Billing {
  id         String        @id @default(uuid())
  businessId String
  status     BillingStatus @default(PENDING)
  issue      Boolean       @default(false)
  createdAt  DateTime      @default(now())
  updatedAt  DateTime      @updatedAt
  business   Business      @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@index([businessId])
  @@index([issue])
}

model ActivityLog {
  id         String             @id @default(uuid())
  userId     String
  action     String
  metadata   Json?
  createdAt  DateTime           @default(now())
  actionType ActivityActionType @default(OTHER)
  businessId String?
  business   Business?          @relation(fields: [businessId], references: [id])
  user       User               @relation(fields: [userId], references: [id])

  @@index([businessId])
  @@index([actionType])
  @@index([createdAt])
}

model Plan {
  id                    String                 @id @default(uuid())
  name                  String                 @unique
  price                 Int
  maxBranches           Int
  maxStaff              Int
  maxCards              Int
  isActive              Boolean                @default(true)
  createdAt             DateTime               @default(now())
  updatedAt             DateTime               @updatedAt
  stripeMonthlyPriceId  String?
  stripeYearlyPriceId   String?
  businessSubscriptions BusinessSubscription[]
}

model BusinessSubscription {
  id                   String             @id @default(uuid())
  businessId           String
  planId               String
  status               SubscriptionStatus @default(ACTIVE)
  startDate            DateTime           @default(now())
  endDate              DateTime?
  createdAt            DateTime           @default(now())
  updatedAt            DateTime           @updatedAt
  maxBranches          Int?
  maxCards             Int?
  maxStaff             Int?
  planName             String?
  price                Float?
  stripePriceId        String?
  stripeStatus         String?
  stripeSubscriptionId String?            @unique
  business             Business           @relation(fields: [businessId], references: [id])
  plan                 Plan               @relation(fields: [planId], references: [id])

  @@index([businessId])
}

model TransactionUndoRequest {
  id                  String            @id @default(uuid())
  businessId          String
  branchId            String?
  staffId             String?
  reason              String
  status              UndoRequestStatus @default(PENDING)
  reviewedBy          String?
  reviewedAt          DateTime?
  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @updatedAt
  customerId          String
  adjustmentRequestId String
  branch              Branch?           @relation(fields: [branchId], references: [id])
  business            Business          @relation(fields: [businessId], references: [id])
  customer            Customer          @relation(fields: [customerId], references: [id])
  staff               Staff?            @relation(fields: [staffId], references: [id])

  @@index([staffId, customerId])
  @@index([adjustmentRequestId])
}

model Review {
  id         String   @id @default(uuid())
  customerId String
  businessId String
  branchId   String
  reviewText String
  branchName String
  star       Int
  hideStatus Boolean  @default(false)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  branch     Branch   @relation(fields: [branchId], references: [id], onDelete: Cascade)
  business   Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  customer   Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@index([businessId])
  @@index([branchId])
}

model StaffPermission {
  id                       String   @id @default(uuid())
  businessId               String   @unique
  allowAddingPoints        Boolean  @default(false)
  allowRedeeming           Boolean  @default(false)
  allowVoids               Boolean  @default(false)
  viewCustomerList         Boolean  @default(false)
  allowViewingActiveOffers Boolean  @default(false)
  editLoyaltyRulesOrOffers Boolean  @default(false)
  addRemoveOtherStaff      Boolean  @default(false)
  createdAt                DateTime @default(now())
  updatedAt                DateTime @updatedAt
  business                 Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
}

model PointAdjustmentRequest {
  id          String            @id @default(uuid())
  type        AdjustmentType
  points      Int
  customerId  String
  staffId     String?
  businessId  String
  branchId    String?
  reason      String?
  status      UndoRequestStatus @default(PENDING)
  reviewedBy  String?
  reviewedAt  DateTime?
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
  branch      Branch?           @relation(fields: [branchId], references: [id])
  business    Business          @relation(fields: [businessId], references: [id])
  customer    Customer          @relation(fields: [customerId], references: [id])
  staff       Staff?            @relation(fields: [staffId], references: [id])
  transaction PointTransaction?

  @@index([staffId, customerId])
  @@index([branchId])
  @@index([status])
}

model Notification {
  id             String                      @id @default(uuid())
  businessId     String
  branchId       String?
  message        String
  sentByStaff    String
  createdAt      DateTime                    @default(now())
  customerStates NotificationCustomerState[]

  @@index([businessId])
  @@index([createdAt])
}

model NotificationCustomerState {
  id             String       @id @default(uuid())
  notificationId String
  customerId     String
  isRead         Boolean      @default(false)
  isDeleted      Boolean      @default(false)
  createdAt      DateTime     @default(now())
  customer       Customer     @relation(fields: [customerId], references: [id], onDelete: Cascade)
  notification   Notification @relation(fields: [notificationId], references: [id], onDelete: Cascade)

  @@unique([notificationId, customerId])
  @@index([customerId])
}

model businessOwnerNotification {
  id         String   @id @default(uuid())
  businessId String   @unique
  settings   Json     @default("[]")
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  business   Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
}

model BranchNotificationSetting {
  id        String   @id @default(uuid())
  branchId  String   @unique
  settings  Json     @default("[]")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  branch    Branch   @relation(fields: [branchId], references: [id], onDelete: Cascade)
}

model CustomerCardWallet {
  id                    String    @id @default(uuid())
  customerId            String
  cardId                String
  isAddedToGoogleWallet Boolean   @default(false)
  isAddedToAppleWallet  Boolean   @default(false)
  lastSyncedAt          DateTime? @default(now())

  customer Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)
  card     Card     @relation(fields: [cardId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([customerId, cardId])
  @@index([customerId])
  @@index([cardId])
}

model PlatformGeoSetting {
  id            String   @id @default(uuid())
  isEnabled     Boolean  @default(true)
  radiusMeters  Int      @default(100)
  cooldownHours Int      @default(8)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model GeoNotificationState {
  id         String   @id @default(uuid())
  customerId String
  branchId   String
  lastSentAt DateTime

  customer Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)
  branch   Branch   @relation(fields: [branchId], references: [id], onDelete: Cascade)

  @@unique([customerId, branchId])
  @@index([customerId])
  @@index([branchId])
}

model ApplePass {
  id                  String              @id @default(uuid())
  passTypeIdentifier  String
  serialNumber        String              @unique
  authenticationToken String
  lastUpdated         DateTime            @default(now())
  registrations       AppleRegistration[]

  @@index([passTypeIdentifier, serialNumber])
}

model AppleDevice {
  id                      String              @id @default(uuid())
  deviceLibraryIdentifier String              @unique
  pushToken               String
  registrations           AppleRegistration[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model AppleRegistration {
  id                      String      @id @default(uuid())
  deviceLibraryIdentifier String
  passTypeIdentifier      String
  serialNumber            String
  device                  AppleDevice @relation(fields: [deviceLibraryIdentifier], references: [deviceLibraryIdentifier], onDelete: Cascade)
  pass                    ApplePass   @relation(fields: [serialNumber], references: [serialNumber], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([deviceLibraryIdentifier, passTypeIdentifier, serialNumber])
}
